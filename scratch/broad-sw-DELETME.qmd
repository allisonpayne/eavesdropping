## Broad scale

Exploring the `aniMotum` package as a way to fit a continuous HMM to the seal GPS data.

I followed the installation instructions [here](https://ianjonsen.github.io/aniMotum/index.html).

```{r}
#| label: setup
#| message: false

library(aniMotum)
library(tidyverse)
library(terra)
library(tidyterra)

theme_set(theme_bw())
```

Loading in our GPS data and formatting it to work with `aniMotum`:

```{r}
#| label: track-data

track <- read_csv(here::here("data/seal_locations.csv"),
                  show_col_types = FALSE) %>% 
  mutate(lc = c("G"), 
         id = c("H391")) %>% 
  format_data(date = "Date_es", coord = c("Longitude", "Latitude")) %>% 
  as.data.frame()

```

Load in acoustic data and aggregate it at 6-hour scale

```{r}
#| label: acou-data

source("R/broad_funcs.R")

#read in acoustic data
acou <- read_csv(here::here("data/detections.csv"),
                 show_col_types = FALSE) %>% 
  mutate(start = as.POSIXct(start, tz = "US/Pacific"), 
         end = as.POSIXct(end, tz = "US/Pacific")) %>% 
  filter(species == "SW")

window_hr <- 6

acou_agg <- tibble(date = seq(first(track$date), last(track$date), by = window_hr * 3600)) %>% 
  mutate(date2 = date - window_hr * 3600,
         SW = map_dbl(date, \(d) sum_odon_exposure(data = acou, d)),
         id = "H391")

```

```{r}
#validated detections
sw_valid <- read_csv(here::here("data/SWCombBouts_Validated.csv"), 
                     show_col_types = FALSE) %>% 
  mutate(start= as.POSIXct(start, tz = "US/Pacific"), 
         end = as.POSIXct(end, tz = "US/Pacific")) %>% 
  select(-notes)

acou_agg_valid <- tibble(date = seq(first(track$date), 
                                    last(track$date), 
                                    by = window_hr * 3600)) %>% 
  mutate(date2 = date - window_hr * 3600,
         SW = map_dbl(date, \(d) sum_odon_exposure(data = sw_valid, d)),
         SW_lag = lag(SW), 
         SW_lead = lead(SW), 
         id = "H391")

```

Trim spatial, acoustic data to audio coverage

```{r}
#| label: trim-data

track <- filter(track, date < last(acou$end))
acou_agg_valid <- filter(acou_agg_valid, date < last(acou$end))

```

Fit model

```{r}
#| label: fit-mod

fit <- fit_ssm(track, 
               vmax = 3, #max travel rate 
               model = "mp", #fits correlated random walk
               time.step = select(acou_agg_valid, id, date), #12 hour steps
               control = ssm_control(verbose = 1), 
               env_formula = ~ SW,
               env_data = acou_agg_valid)

```

```{r}
#| label: summ-mod

fit$ssm$H391$par
est <- fit$ssm$H391$par["beta", 1]
se <- fit$ssm$H391$par["beta", 2]
pnorm(est, mean = 0, sd = se, lower.tail = TRUE)

```

```{r}
#| label: plot-mod

p <- plot(fit, type = 3)$H391
p +
  geom_point(aes(date, SW / 6), acou_agg_valid) +
  scale_y_continuous(sec.axis = sec_axis(~ . * 6, name = "SW (hours)"))

```

```{r}
#| label: plot-map

ggplot(fit$ssm[[1]]$predicted) + 
  geom_sf(aes(color = g)) +
  scale_color_gradient2(midpoint = 0.5, limits = c(0, 1))
```

```{r}
fit_lag <- fit_ssm(track, 
               vmax = 3, #max travel rate 
               model = "mp", #fits correlated random walk
               time.step = select(acou_agg_valid, id, date), #12 hour steps
               control = ssm_control(verbose = 1), 
               env_formula = ~ SW_lag,
               env_data = acou_agg_valid)
```

```{r}
#get lag results
fit_lag$ssm$H391$par
est_lag <- fit_lag$ssm$H391$par["beta", 1]
se_lag <- fit_lag$ssm$H391$par["beta", 2]
pnorm(est_lag, mean = 0, sd = se_lag, lower.tail = TRUE)
```

```{r}
fit_lead <- fit_ssm(track, 
               vmax = 3, #max travel rate 
               model = "mp", #fits correlated random walk
               time.step = select(acou_agg_valid, id, date), #12 hour steps
               control = ssm_control(verbose = 1), 
               env_formula = ~ SW_lead,
               env_data = acou_agg_valid)
```

```{r}
#plot lead results
fit_lead$ssm$H391$par
est_lead <- fit_lead$ssm$H391$par["beta", 1]
se_lead <- fit_lead$ssm$H391$par["beta", 2]
pnorm(est_lead, mean = 0, sd = se_lead, lower.tail = TRUE)
```
