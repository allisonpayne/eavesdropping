# Broad scale

Using the `aniMotum` package as a way to fit a continuous HMM to the seal GPS data.

```{r}
#| label: setup
#| message: false

library(aniMotum)
library(tidyverse)
library(terra)
library(tidyterra)

theme_set(theme_bw())
```

Loading in our GPS data and formatting it to work with `aniMotum`:

```{r}
#| label: track-data

track <- read_csv(here::here("data/seal_locations.csv"),
                  show_col_types = FALSE) %>% 
  mutate(lc = c("G"), 
         id = c("H391")) %>% 
  format_data(date = "Date_es", coord = c("Longitude", "Latitude")) %>% 
  as.data.frame()

```

Load in acoustic data and aggregate it at 6-hour scale

```{r}
#| label: acou-data

source(here::here("R/broad_funcs.R"))

#read in the general acoustic data
acou <- read_csv(here::here("data/detections.csv"),
                 show_col_types = FALSE) %>% 
  mutate(start = as.POSIXct(start, tz = "US/Pacific"), 
         end = as.POSIXct(end, tz = "US/Pacific"))

#read in sperm whale data 
sw_valid <- read_csv(here::here("data/SWCombBouts_Validated.csv"), 
                     show_col_types = FALSE) %>% 
  mutate(start= as.POSIXct(start, tz = "US/Pacific"), 
         end = as.POSIXct(end, tz = "US/Pacific")) %>% 
  select(-notes)

window_hr <- 6

acou_agg_valid <- tibble(date = seq(first(track$date), 
                                    last(track$date), 
                                    by = window_hr * 3600)) %>% 
  mutate(date2 = date - window_hr * 3600,
         SW = map_dbl(date, \(d) sum_odon_exposure(data = sw_valid, d)),
         SW_lag = lag(SW), 
         SW_lead = lead(SW), 
         SW_std = (SW - mean(SW)) / sd(SW),
         id = "H391")

```

Trim spatial, acoustic data to audio coverage

```{r}
#| label: trim-data

track <- filter(track, date < last(acou$end))
acou_agg_valid <- filter(acou_agg_valid, date < last(acou$end))

```

Fit model

```{r}
#| label: fit-mod

fit <- fit_ssm(track, 
               vmax = 3, #max travel rate 
               model = "mp", #fits correlated random walk
               time.step = select(acou_agg_valid, id, date), #6 hour steps
               control = ssm_control(verbose = 0), 
               env_formula = ~ SW,
               env_data = select(acou_agg_valid, id, date, SW))

```

```{r}
#| label: summ-mod

fit$ssm$H391$par
est <- fit$ssm$H391$par["beta", 1]
se <- fit$ssm$H391$par["beta", 2]
pnorm(est, mean = 0, sd = se, lower.tail = TRUE)

```

```{r}
#| label: plot-mod

p <- plot(fit, type = 3)$H391
p +
  geom_point(aes(date, SW / max(SW)), acou_agg_valid) +
  scale_y_continuous(sec.axis = sec_axis(~ . * max(acou_agg_valid$SW), name = "SW (hours)"))

```

```{r}
#| label: plot-map

ggplot(fit$ssm[[1]]$predicted) + 
  geom_sf(aes(color = g)) +
  scale_color_gradient2(midpoint = 0.5, limits = c(0, 1))
```

## Alternative hypotheses:

### 1. Luck

Maybe sperm whales and elephant seals both just happened to converge on the patch. If that's true, then adding a 6 hour *lag time* or *lead time* to the model should have similar results.

```{r}
#| label: lead-mod

fit_lead <- fit_ssm(track, 
               vmax = 3, #max travel rate 
               model = "mp", #fits correlated random walk
               time.step = select(acou_agg_valid, id, date), #12 hour steps
               control = ssm_control(verbose = 0), 
               env_formula = ~ SW_lead,
               env_data = acou_agg_valid)

#get lead results
fit_lead$ssm$H391$par
est_lead <- fit_lead$ssm$H391$par["beta", 1]
se_lead <- fit_lead$ssm$H391$par["beta", 2]
pnorm(est_lead, mean = 0, sd = se_lead, lower.tail = TRUE)
```

```{r}
#| label: lag-mod

fit_lag <- fit_ssm(track, 
               vmax = 3, #max travel rate 
               model = "mp", #fits correlated random walk
               time.step = select(acou_agg_valid, id, date), #12 hour steps
               control = ssm_control(verbose = 0), 
               env_formula = ~ SW_lag,
               env_data = acou_agg_valid)

#get lag results
fit_lag$ssm$H391$par
est_lag <- fit_lag$ssm$H391$par["beta", 1]
se_lag <- fit_lag$ssm$H391$par["beta", 2]
pnorm(est_lag, mean = 0, sd = se_lag, lower.tail = TRUE)
```

A model fitted to the lag/lead values are not at *all* significant (.5-.6 one-tailed p-test), while the model fitted to the actual values is (0.03, 1 tailed p test).

### 2. Memory

Maybe H391 has been to that patch before and knew that there was good food there, and she didn't actually use the sperm whale cue at all. We don't know what she does every year, but we do know that for her two other instrumented trips, she traveled offshore - so this isn't just "her spot."

### 3. Other environmental cues

Maybe the seal wasn't using sperm whales at all, but their calls happened to coincide with another environmental cue, like SST, temp at depth, or FTLE. We could use the tag's temperature sensor and FTLE measurements to fit our same SSM with oceanographic covariates instead of sperm whale presence and see if the fit is better or worse than with SW.

#### Next step: the fine scale.

We will fit a hidden markov model to the seal's diving behavior and allow the properties of the sperm whale clicks (received level and peak frequency, both associated with how far away the whales are) to influence her transition probabilities.
