---
title: "dive_type"
format: html
---

Goal: Get images of all the dives that I can use to manually dive type (with a spreadsheet and help from the tool that John made).

```{r}
library(tidyverse)
library(gridExtra)
library(zoo)

depth <- read_csv(here::here("data/23A1302/out-Archive.csv"), show_col_types = FALSE) %>% 
  drop_na(Depth) %>% 
  mutate(Date = as.POSIXct(Time, format = "%H:%M:%S %d-%b-%Y", tz = "UTC")) %>% 
  rename(no_zoc_depth = Depth,
         Depth = `Corrected Depth`)

ggplot(depth, aes(Date, Depth)) +
  geom_line(linewidth = 0.03) +
  scale_y_reverse() +
  theme_bw()

```

```{r}
#functions for getting dive stats
get_dives <- function(depth, surface_threshold, bottom_percent) {
  depth %>% 
    mutate(
      surface = Depth < surface_threshold, 
      dive_change = surface & lag(!surface, default = TRUE), 
      dive_id = cumsum(dive_change)
    ) %>% 
    filter(!surface) %>%  # Remove surface intervals
    group_by(dive_id) %>% 
    mutate(max_depth = max(Depth, na.rm = TRUE), 
           bottom_thresh = max_depth * 0.80, #threshold at bottom 80% of the dive
           at_bottom = Depth >= bottom_thresh, 
           time_diff = as.numeric(difftime(Date, lag(Date), units = "secs")),
           depth_change = Depth - lag(Depth),
           direction = sign(depth_change),  # +1 = deeper, -1 = shallower
           direction_change = direction != lag(direction)  # Wiggle detected!
    ) %>%
    ungroup()
}

dives <- get_dives(depth, 5, 80)

```

Filter to only when we had recordings.

```{r}
recording <- read.csv("data/wav_timestamps.csv") %>% 
  mutate(start = ymd_hms(start_time, tz = "UTC"),
         end = ymd_hms(end_time, tz = "UTC")) %>% 
  drop_na(end)

recording_start <- recording$start[1]
recording_end <- last(recording$end)

dives <- dives %>% 
  filter(between(Date, recording_start, recording_end))
```

Plot each dive in the top panel, then the dive with two dives on either side on the bottom panel.

```{r}
#try it for 1 dive; let's do the 100th dive
focal_dive <- 100 

focal_dive_data <- dives %>% 
  filter(dive_id == 100)

focal_dive_plot <- ggplot(focal_dive_data, aes(Date, Depth)) +
  geom_line(linewidth = 0.3) +
  scale_y_reverse() +
  theme_bw() + 
  labs(title = paste("Dive =", focal_dive))
  

context <- c(-2, -1, 0, 1, 2)

context_dive_data <- dives %>% 
  filter(dive_id %in% (focal_dive + context))

context_dive_plot <- ggplot(context_dive_data, aes(Date, 
                                                   Depth, 
                                                   linewidth = dive_id == focal_dive, 
                                                   group = 1)) +
  geom_line() +
  scale_linewidth_manual(values = c(0.3, 1)) + 
  scale_y_reverse() +
  theme_bw() + 
  theme(legend.position = "None")

grid.arrange(focal_dive_plot, context_dive_plot)
```

Do this for every dive. Max suggests using walk and calling ggsave within that. First, make the function that will plot the focal and context dives.

```{r}
#context dives should be a vector where the focal dive is 0, and the context is however many dives on either side of the focal dive you want. So if you want two dives on either side, it should be a vector c(-2, -1, 0, 1, 2). 

plot_dives <- function(dive_data, focal_dive, context_dives){
  
  focal_dive_plot <- dive_data %>% 
    filter(dive_id == focal_dive) %>% 
    ggplot(aes(Date, Depth)) +
    geom_line(linewidth = 0.3) +
    scale_y_reverse() +
    theme_bw() +
    labs(title = paste("Dive =", focal_dive))
  
  context_dive_data <- dives %>% 
    filter(dive_id %in% (focal_dive + context))
  
  context_dive_plot <- dive_data %>% 
    filter(dive_id %in% (focal_dive + context_dives)) %>% 
    ggplot(aes(Date, 
               Depth, 
               linewidth = dive_id == focal_dive, 
               group = 1)) +
    geom_line() +
    scale_linewidth_manual(values = c(0.3, 1)) + 
    scale_y_reverse() +
    theme_bw() + 
    theme(legend.position = "None")
  
  combined_plot <- grid.arrange(focal_dive_plot, context_dive_plot)
  
  ggsave(paste0("paper/dive_type/dive_images/dive", focal_dive, ".png"), 
         plot = combined_plot,
         width = 7, 
         height = 5, 
         units = "in")
}

#testing
#plot_dives(dives, 100, c(-2, -1, 0, 1, 2))
```

```{r}
#do this for every dive 
walk(unique(dives$dive_id), 
     \(fd) plot_dives(dives, fd, -2:2))
```
